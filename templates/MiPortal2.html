<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Administrar</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/miportal2.css') }}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<header class="main-header" id="movible-header">
    <div class="nav-left">
        <a href="{{ url_for('root') }}"><img src="{{ url_for('static', path='img/logo_casa.png') }}" alt="Logo_Casa" class="Logo_Casa"/></a>
    </div>
    <div class="nav-center">
        <img src="{{ url_for('static', path='img/img.png') }}" alt="Logo Fundación" class="logo"/>
    </div>
    <div class="nav-right">
        <img src="{{ url_for('static', path='img/img_1.png') }}" alt="Foto perfil"/>
        <div class="dropdown">
            <span>{{ usuario or "Nombre Usuario" }}</span>
            <div class="dropdown-content"><a href="{{ url_for('logout') }}">Cerrar sesión</a></div>
        </div>
    </div>
</header>

<main class="contenedor-principal">
    <aside class="columna-izquierda">
        <button class="boton-admin" onclick="mostrarOpciones('gestores')">Gestores</button>
        <button class="boton-admin" onclick="mostrarOpciones('cuidadores')">Cuidadores</button>
        <button class="boton-admin" onclick="mostrarOpciones('hogares')">Hogares</button>
        <button class="boton-admin" onclick="mostrarOpciones('clientes')">Clientes</button>
    </aside>

    <section class="columna-derecha">
        <!-- Panel para Gestores -->
        <!-- Panel para Gestores -->
        <div id="opciones-gestores" class="sub-botones fila-dos-botones">
            <button class="boton-subgestor" onclick="mostrarFormularioGestor()">Añadir gestor</button>

            <!-- Formulario Añadir Gestor -->
            <form id="formulario-gestor" class="formulario-usuario" style="display: none;" onsubmit="event.preventDefault();">
                <div class="campo-formulario">
                    <label><i class="fas fa-user"></i> Nombre:</label>
                    <input type="text" name="nombre" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-user-tag"></i> Primer apellido:</label>
                    <input type="text" name="apellido1" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-user-tag"></i> Segundo apellido:</label>
                    <input type="text" name="apellido2">
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-user-circle"></i> Nombre de usuario:</label>
                    <input type="text" name="usuario" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-lock"></i> Contraseña:</label>
                    <input type="password" name="contrasena" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-palette"></i> Color</label>
                    <input type="color" name="color" value="#ff0000" required>
                </div>
                <button type="submit" class="boton-enviar">Guardar</button>
            </form>

            <button class="boton-subgestor" onclick="mostrarEstadosGestor()">Modificar gestor</button>

            <!-- Contenedor de Activos/Inactivos -->
            <div id="estado-gestor" class="estado-container" style="display: none;">
                <!-- Gestores Activos -->
                <div>
                    <div class="estado-caja">Activo</div>
                    <div id="gestor-activo">
                        <label for="gestor-activo-select">Seleccionar gestor:</label>
                        <select id="gestor-activo-select">
                            <option value="">-- Seleccionar --</option>
                            <!-- Se llenará dinámicamente -->
                        </select>
                    </div>
                </div>

                <!-- Gestores Inactivos -->
                <div>
                    <div class="estado-caja">Inactivo</div>
                    <div class="gestor-inactivo">
                        <label for="gestor-inactivo-select">Seleccionar gestor:</label>
                        <select id="gestor-inactivo-select">
                            <option value="">-- Seleccionar --</option>
                            <!-- Se llenará dinámicamente -->
                        </select>
                    </div>
                </div>
                <!-- Formulario de edición para gestor seleccionado -->
                <div id="editar-gestor" style="display: none;">
                    <table>
                        <tr>
                            <td><label>Nombre:</label></td>
                            <td><input type="text" id="nombre-gestor" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Primer apellido:</label></td>
                            <td><input type="text" id="apellido1-gestor" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Segundo apellido:</label></td>
                            <td><input type="text" id="apellido2-gestor" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Nombre de usuario:</label></td>
                            <td><input type="text" id="usuario-gestor" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Contraseña:</label></td>
                            <td><input type="password" id="contrasena-gestor" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Color:</label></td>
                            <td><input type="color" id="color-gestor" disabled/></td>
                        </tr>
                    </table>
                    <button id="modificar-gestor" onclick="activarEdicionGestor()">Modificar</button>
                    <button id="guardar-gestor" onclick="guardarCambiosGestor()" style="display: none;">Guardar cambios</button>
                </div>
            </div>
        </div>



        <!-- Sección de Cuidadores -->
        <div id="opciones-cuidadores" class="sub-botones fila-dos-botones">
            <button class="boton-subcuidador" onclick="mostrarFormularioCuidador()">Añadir cuidador</button>

            <!-- Formulario Añadir Cuidador -->
            <form id="formulario-cuidador" class="formulario-usuario" style="display: none;" onsubmit="event.preventDefault();">
                <div class="campo-formulario">
                    <label><i class="fas fa-user"></i> Nombre:</label>
                    <input type="text" name="nombre" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-user-tag"></i> Primer apellido:</label>
                    <input type="text" name="apellido1" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-user-tag"></i> Segundo apellido:</label>
                    <input type="text" name="apellido2">
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-phone"></i> Teléfono:</label>
                    <input type="tel" name="telefono" pattern="[0-9]{9}" placeholder="Ej: 612345678" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-user-circle"></i> Nombre de usuario:</label>
                    <input type="text" name="usuario" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-lock"></i> Contraseña:</label>
                    <input type="password" name="contrasena" required>
                </div>
                <button type="submit" class="boton-enviar">Guardar</button>
            </form>

            <button class="boton-subcuidador" onclick="mostrarEstadosCuidador()">Modificar cuidador</button>

            <!-- Contenedor para Cuidadores Activos -->
            <div id="estado-cuidador" class="estado-container" style="display: none;">
                <div>
                    <div class="estado-caja">Activo</div>
                    <div id="cuidador-activo">
                        <label for="cuidador-activo-select">Seleccionar cuidador:</label>
                        <select id="cuidador-activo-select">
                            <option value="">-- Seleccionar --</option>
                            <!-- Opciones se llenarán dinámicamente -->
                        </select>
                    </div>
                </div>



                <!-- Cuidadores Inactivos -->
                <div>
                    <div class="estado-caja">Inactivo</div>
                    <div class="cuidador-inactivo">
                        <label for="cuidador-inactivo-select">Seleccionar cuidador:</label>
                        <select id="cuidador-inactivo-select">
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                </div>
                <!-- Formulario para editar cuidador seleccionado -->
                <div id="editar-cuidador" style="display: none;">
                    <table>
                        <tr>
                            <td><label>Nombre:</label></td>
                            <td><input type="text" id="nombre-cuidador" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Primer apellido:</label></td>
                            <td><input type="text" id="apellido1-cuidador" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Segundo apellido:</label></td>
                            <td><input type="text" id="apellido2-cuidador" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Nombre de usuario:</label></td>
                            <td><input type="text" id="usuario-cuidador" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Contraseña:</label></td>
                            <td><input type="password" id="contrasena-cuidador" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Teléfono:</label></td>
                            <td><input type="text" id="telefono-cuidador" disabled/></td>
                        </tr>
                    </table>
                    <button id="modificar-cuidador" onclick="activarEdicionCuidador()">Modificar</button>
                    <button id="guardar-cuidador" onclick="guardarCambiosCuidador()" style="display: none;">Guardar cambios</button>
                </div>
            </div>
        </div>



        <!-- Sección de Hogares -->
        <div id="opciones-hogares" class="sub-botones fila-dos-botones">
            <button class="boton-subhogar" onclick="mostrarFormularioHogar()">Añadir hogar</button>

            <!-- Formulario Añadir Hogar -->
            <form id="formulario-hogar" class="formulario-usuario" style="display: none;" onsubmit="event.preventDefault();">
                <div class="campo-formulario">
                    <label><i class="fas fa-map-marker-alt"></i> Dirección:</label>
                    <input type="text" name="direccion" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-envelope"></i> Código Postal:</label>
                    <input type="text" name="codigo_postal" pattern="[0-9]{5}" placeholder="Ej: 28001" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-flag"></i> Provincia:</label>
                    <input type="text" name="provincia" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-link"></i> URL Home Assistant:</label>
                    <input type="url" name="url_homeassistant" placeholder="https://..." required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-key"></i> Token Home Assistant:</label>
                    <input type="text" name="token_homeassistant" required>
                </div>
                <button type="submit" class="boton-enviar">Guardar</button>
            </form>

            <button class="boton-subhogar" onclick="mostrarEstadosHogar()">Modificar hogar</button>

            <!-- Panel de Hogares Activos e Inactivos -->
            <div id="estado-hogar" class="estado-container" style="display: none;">
                <div>
                    <div class="estado-caja">Activo</div>
                    <div id="hogar-activo">
                        <label for="hogar-activo-select">Seleccionar hogar:</label>
                        <select id="hogar-activo-select">
                            <option value="">-- Seleccionar --</option>
                            <!-- Opciones se llenarán dinámicamente -->
                        </select>
                    </div>
                </div>



                <!-- Hogares Inactivos -->
                <div>
                    <div class="estado-caja">Inactivo</div>
                    <div class="hogar-inactivo">
                        <label for="hogar-inactivo-select">Seleccionar hogar:</label>
                        <select id="hogar-inactivo-select">
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                </div>
                <!-- Formulario para editar hogar seleccionado -->
                <div id="editar-hogar" style="display: none;">
                    <table>
                        <tr>
                            <td><label>Dirección:</label></td>
                            <td><input type="text" id="direccion-hogar" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Código Postal:</label></td>
                            <td><input type="text" id="codigo_postal-hogar" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Provincia:</label></td>
                            <td><input type="text" id="provincia-hogar" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>URL Home Assistant:</label></td>
                            <td><input type="text" id="url_homeassistant-hogar" disabled/></td>
                        </tr>
                        <tr>
                            <td><label>Token Home Assistant:</label></td>
                            <td><input type="text" id="token_homeassistant-hogar" disabled/></td>
                        </tr>
                    </table>
                    <button id="modificar-hogar" onclick="activarEdicionHogar()">Modificar</button>
                    <button id="guardar-hogar" onclick="guardarCambiosHogar()" style="display: none;">Guardar cambios</button>
                </div>
            </div>
        </div>


        <!-- Sección de Clientes -->
        <div id="opciones-clientes" class="sub-botones fila-dos-botones">
            <button class="boton-subcliente" onclick="mostrarFormularioCliente()">Añadir cliente</button>

            <!-- Formulario Añadir Cliente -->
            <form id="formulario-cliente" class="formulario-usuario-dos-columnas" style="display: none;" onsubmit="event.preventDefault();">
                <!-- Columna izquierda -->
                <div class="columna-formulario">
                    <div class="campo-formulario">
                        <label><i class="fas fa-user-tie"></i> Gestor:</label>
                        <select name="gestor" required>
                            <option value="">-- Seleccionar gestor --</option>
                            <!-- Opciones se llenarán dinámicamente -->
                        </select>
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-user"></i> Nombre:</label>
                        <input type="text" name="nombre" required>
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-user-tag"></i> Primer apellido:</label>
                        <input type="text" name="apellido1" required>
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-user-tag"></i> Segundo apellido:</label>
                        <input type="text" name="apellido2">
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-id-card"></i> DNI:</label>
                        <input type="text" name="dni" required>
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-venus-mars"></i> Sexo:</label>
                        <select name="sexo" required>
                            <option value="">-- Seleccionar sexo --</option>
                            <option value="hombre">Hombre</option>
                            <option value="mujer">Mujer</option>
                        </select>
                    </div>
                </div>

                <!-- Columna derecha -->
                <div class="columna-formulario">
                    <div class="campo-formulario">
                        <label><i class="fas fa-calendar"></i> Fecha de nacimiento:</label>
                        <input type="date" name="fecha_nacimiento" required>
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-phone"></i> Teléfono personal:</label>
                        <input type="tel" name="telefono_personal">
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-phone-volume"></i> Teléfono familiar:</label>
                        <input type="tel" name="telefono_familiar">
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-home"></i> Hogar:</label>
                        <select name="hogar" required>
                            <option value="">-- Seleccionar hogar --</option>
                            <!-- Opciones se llenarán dinámicamente -->
                        </select>
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-align-left"></i> Descripción:</label>
                        <textarea name="descripcion" rows="3"></textarea>
                    </div>
                </div>

                <div class="boton-enviar-contenedor">
                    <button type="submit" class="boton-enviar">Guardar</button>
                </div>
            </form>

            <button class="boton-subcliente" onclick="mostrarEstadosCliente()">Modificar cliente</button>

            <!-- Panel de Clientes Activos e Inactivos -->
            <div id="estado-cliente" class="estado-container" style="display: none;">
                <!-- Clientes Activos -->
                <div>
                    <div class="estado-caja">Activo</div>
                    <div id="cliente-activo">
                        <label for="cliente-activo-select">Seleccionar cliente:</label>
                        <select id="cliente-activo-select">
                            <option value="">-- Seleccionar --</option>
                            <!-- Opciones se llenarán dinámicamente -->
                        </select>
                    </div>
                </div>
                <!-- Clientes Inactivos -->
                <div>
                    <div class="estado-caja">Inactivo</div>
                    <div class="cliente-inactivo">
                        <label for="cliente-inactivo-select">Seleccionar cliente:</label>
                        <select id="cliente-inactivo-select">
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                </div>
                <!-- Formulario para editar cliente seleccionado -->
                <div id="editar-cliente" style="display: none;">
                    <div class="columna-formulario-container">
                        <!-- Columna izquierda -->
                        <div class="columna-formulario">
                            <!-- Campo de Gestor -->
                            <div class="campo-formulario">
                                <label><i class="fas fa-user-tie"></i> Gestor:</label>
                                <select name="gestor" id="gestor-cliente" disabled>
                                    <option value="">-- Seleccionar gestor --</option>
                                    <!-- Opciones se llenarán dinámicamente -->
                                </select>
                            </div>
                            <div class="campo-formulario">
                                <label><i class="fas fa-user"></i> Nombre:</label>
                                <input type="text" id="nombre-cliente" disabled />
                            </div>
                            <div class="campo-formulario">
                                <label><i class="fas fa-user-tag"></i> Primer apellido:</label>
                                <input type="text" id="apellido1-cliente" disabled />
                            </div>
                            <div class="campo-formulario">
                                <label>Segundo apellido:</label>
                                <input type="text" id="apellido2-cliente" disabled />
                            </div>
                            <div class="campo-formulario">
                                <label>DNI:</label>
                                <input type="text" id="dni-cliente" disabled />
                            </div>
                        </div>

                        <!-- Columna derecha -->
                        <div class="columna-formulario">
                            <div class="campo-formulario">
                                <label><i class="fas fa-venus-mars"></i> Sexo:</label>
                                <select name="sexo" id="sexo-cliente" disabled>
                                    <option value="">-- Seleccionar sexo --</option>
                                    <option value="hombre">Hombre</option>
                                    <option value="mujer">Mujer</option>
                                </select>
                            </div>
                            <div class="campo-formulario">
                                <label><i class="fas fa-calendar"></i> Fecha de nacimiento:</label>
                                <input type="date" id="fecha_nacimiento-cliente" disabled />
                            </div>
                            <div class="campo-formulario">
                                <label><i class="fas fa-phone"></i> Teléfono personal:</label>
                                <input type="tel" id="telefono-personal-cliente" disabled />
                            </div>
                            <div class="campo-formulario">
                                <label><i class="fas fa-phone-volume"></i> Teléfono familiar:</label>
                                <input type="tel" id="telefono-familiar-cliente" disabled />
                            </div>
                            <div class="campo-formulario">
                                <label><i class="fas fa-home"></i> Hogar:</label>
                                <select id="hogar-cliente" disabled>
                                    <option value="">-- Seleccionar hogar --</option>
                                </select>
                            </div>
                            <div class="campo-formulario">
                                <label><i class="fas fa-align-left"></i> Descripción:</label>
                                <textarea id="descripcion-cliente" rows="3" disabled></textarea>
                            </div>
                        </div>
                    </div>

                    <button id="modificar-cliente" onclick="activarEdicionCliente()">Modificar</button>
                    <button id="guardar-cliente" onclick="guardarCambiosCliente()" style="display: none;">Guardar cambios</button>
                </div>
            </div>
        </div>

    </section>
</main>

<script>

    // Almacenes locales de datos completos
    const datosGestores = {};
    const datosCuidadores = {};
    const datosHogares = {};
    const datosClientes = {};

    // Función genérica para cargar datos en un select
    function mostrarOpciones(tipo) {
        document.querySelectorAll('.sub-botones').forEach(div => div.style.display = 'none');

        // Ocultar todos los paneles de estados y formularios
        document.getElementById('estado-gestor').style.display = 'none';
        document.getElementById('estado-cuidador').style.display = 'none';
        document.getElementById('estado-hogar').style.display = 'none';
        document.getElementById('estado-cliente').style.display = 'none';
        document.getElementById('formulario-gestor').style.display = 'none';
        document.getElementById('formulario-cuidador').style.display = 'none';
        document.getElementById('formulario-hogar').style.display = 'none';
        document.getElementById('formulario-cliente').style.display = 'none';

        const panel = document.getElementById(`opciones-${tipo}`);
        if (panel) panel.style.display = 'flex';
    }

    function mostrarFormularioGestor() {
        document.getElementById('estado-gestor').style.display = 'none';
        document.getElementById('formulario-gestor').style.display = 'flex';
    }

    function mostrarFormularioCuidador() {
        document.getElementById('estado-cuidador').style.display = 'none';
        document.getElementById('formulario-cuidador').style.display = 'flex';
    }

    function mostrarFormularioHogar() {
        document.getElementById('estado-hogar').style.display = 'none';
        document.getElementById('formulario-hogar').style.display = 'flex';
    }

    function mostrarFormularioCliente() {
        document.getElementById('estado-cliente').style.display = 'none';
        document.getElementById('formulario-cliente').style.display = 'flex';

        const selectGestor = document.querySelector('select[name="gestor"]');
        const selectHogar = document.querySelector('select[name="hogar"]');

        cargarDatos('/gestoresActivos', selectGestor, 'gestor', 'activo', gestor => 
            `${gestor.nombre} ${gestor.apellido1} ${gestor.apellido2 || ''}`.trim());
        
        cargarDatos('/VerHogaresActivos', selectHogar, 'hogar', 'activo', hogar => 
            `${hogar.direccion} (${hogar.codigo_postal})`);
    }

    
function cargarDatos(url, selectElement, tipo, estado, formatter = null) {
    let almacen;
    if (tipo === 'gestor') almacen = datosGestores;
    else if (tipo === 'cuidador') almacen = datosCuidadores;
    else if (tipo === 'hogar') almacen = datosHogares;
    else if (tipo === 'cliente') almacen = datosClientes;

    fetch(url)
        .then(response => response.json())
        .then(json => {
            if (!json.success || !Array.isArray(json.data)) {
                throw new Error('Respuesta incorrecta desde ' + url);
            }

            selectElement.length = 1;
            almacen && Object.keys(almacen).forEach(k => delete almacen[k]);  // limpiar

            json.data.forEach(item => {
                const id = item.id || item.id_gestor || item.id_cliente || item.id_cuidador || item.id_hogar;
                almacen && (almacen[id] = item);  // guardar objeto completo

                const option = document.createElement('option');
                option.value = id;
                option.textContent = formatter ? formatter(item) : (item.nombre || item.direccion || 'Sin nombre');
                selectElement.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error cargando ' + url + ':', error);
        });

        fetch(url)
            .then(response => response.json())
            .then(json => {
                if (!json.success || !Array.isArray(json.data)) {
                    throw new Error('Respuesta incorrecta desde ' + url);
                }

                selectElement.length = 1;

                json.data.forEach(item => {
                    const option = document.createElement('option');
                    const id = item.id || item.id_gestor || item.id_cliente || item.id_cuidador || item.id_hogar;
                    option.value = id;
                    option.textContent = formatter ? formatter(item) : (item.nombre || item.direccion || 'Sin nombre');
                    selectElement.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error cargando ' + url + ':', error);
            });
    }

    // Funciones para mostrar contenedores
    function mostrarContenedorGestores() {
        document.getElementById('estado-gestor').style.display = 'flex';
        cargarDatos('/gestoresActivos', document.getElementById('gestor-activo-select'), 'gestor', 'activo', 
            gestor => `${gestor.nombre} ${gestor.apellido1} ${gestor.apellido2 || ''}`.trim());
        cargarDatos('/gestoresInactivos', document.getElementById('gestor-inactivo-select'), 'gestor', 'inactivo', 
            gestor => `${gestor.nombre} ${gestor.apellido1} ${gestor.apellido2 || ''}`.trim());
    }

    function mostrarContenedorCuidadores() {
        document.getElementById('estado-cuidador').style.display = 'flex';
        cargarDatos('/cuidadoresActivos', document.getElementById('cuidador-activo-select'), 'cuidador', 'activo', 
            cuidador => `${cuidador.nombre} ${cuidador.apellido1} ${cuidador.apellido2 || ''}`.trim());
        cargarDatos('/cuidadoresInactivos', document.getElementById('cuidador-inactivo-select'), 'cuidador', 'inactivo', 
            cuidador => `${cuidador.nombre} ${cuidador.apellido1} ${cuidador.apellido2 || ''}`.trim());
    }

    function mostrarContenedorHogares() {
        document.getElementById('estado-hogar').style.display = 'flex';
        cargarDatos('/VerHogaresActivos', document.getElementById('hogar-activo-select'), 'hogar', 'activo', 
            hogar => `${hogar.direccion} (${hogar.codigo_postal})`);
        cargarDatos('/VerHogaresInactivos', document.getElementById('hogar-inactivo-select'), 'hogar', 'inactivo', 
            hogar => `${hogar.direccion} (${hogar.codigo_postal})`);
    }

    function mostrarContenedorClientes() {
        document.getElementById('estado-cliente').style.display = 'flex';
        cargarDatos('/clientesActivos', document.getElementById('cliente-activo-select'), 'cliente', 'activo', 
            cliente => `${cliente.nombre} ${cliente.apellido1} ${cliente.apellido2 || ''}`.trim());
        cargarDatos('/clientesInactivos', document.getElementById('cliente-inactivo-select'), 'cliente', 'inactivo', 
            cliente => `${cliente.nombre} ${cliente.apellido1} ${cliente.apellido2 || ''}`.trim());
    }

    // Funciones para mostrar estados
    function mostrarEstadosGestor() {
        document.getElementById('formulario-gestor').style.display = 'none';
        mostrarContenedorGestores();
    }

    function mostrarEstadosCuidador() {
        document.getElementById('formulario-cuidador').style.display = 'none';
        mostrarContenedorCuidadores();
    }

    function mostrarEstadosHogar() {
        document.getElementById('formulario-hogar').style.display = 'none';
        mostrarContenedorHogares();
    }

    function mostrarEstadosCliente() {
        document.getElementById('formulario-cliente').style.display = 'none';
        mostrarContenedorClientes();
    }

    // Función genérica para mostrar formulario de edición
    function mostrarFormularioEdicion(tipo, id, estado) {
        // Ocultar formularios anteriores
        document.querySelectorAll(`#editar-${tipo}`).forEach(form => form.style.display = 'none');

        // Mostrar formulario de edición
        const formulario = document.getElementById(`editar-${tipo}`);
        formulario.style.display = 'block';

        // Limpiar y deshabilitar campos
        const campos = document.querySelectorAll(`#editar-${tipo} input, #editar-${tipo} select, #editar-${tipo} textarea`);
        campos.forEach(campo => {
            campo.value = '';
            campo.disabled = true;
        });

        // Determinar el endpoint según el tipo
        let endpoint = '';
        if (tipo === 'gestor' || tipo === 'cuidador') {
            endpoint = `/trabajadores/${id}`;
        } else {
            endpoint = `/${tipo}/${id}`;
        }

        // Obtener datos del elemento seleccionado
        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    const item = data.data;
                    
                    // Rellenar campos según el tipo
                    if (tipo === 'gestor') {
                        document.getElementById('nombre-gestor').value = item.nombre || '';
                        document.getElementById('apellido1-gestor').value = item.apellido1 || '';
                        document.getElementById('apellido2-gestor').value = item.apellido2 || '';
                        document.getElementById('usuario-gestor').value = item.nombre_usuario || '';
                        document.getElementById('contrasena-gestor').value = item.contraseña || '';
                        document.getElementById('color-gestor').value = item.gestor_data?.color || '#000000';
                    } 
                    else if (tipo === 'cuidador') {
                        document.getElementById('nombre-cuidador').value = item.nombre || '';
                        document.getElementById('apellido1-cuidador').value = item.apellido1 || '';
                        document.getElementById('apellido2-cuidador').value = item.apellido2 || '';
                        document.getElementById('usuario-cuidador').value = item.nombre_usuario || '';
                        document.getElementById('contrasena-cuidador').value = item.contraseña || '';
                        document.getElementById('telefono-cuidador').value = item.cuidador_data?.telefono || '';
                    } 
                    else if (tipo === 'hogar') {
                        document.getElementById('direccion-hogar').value = item.direccion || '';
                        document.getElementById('codigo_postal-hogar').value = item.Cod_Postal || '';
                        document.getElementById('provincia-hogar').value = item.Provincia || '';
                        document.getElementById('url_homeassistant-hogar').value = item.url || '';
                        document.getElementById('token_homeassistant-hogar').value = item.token || '';
                    } 
                    else if (tipo === 'cliente') {
                        document.getElementById('nombre-cliente').value = item.nombre || '';
                        document.getElementById('apellido1-cliente').value = item.apellido1 || '';
                        document.getElementById('apellido2-cliente').value = item.apellido2 || '';
                        document.getElementById('dni-cliente').value = item.dni || '';
                        document.getElementById('sexo-cliente').value = item.sexo || '';
                        document.getElementById('fecha_nacimiento-cliente').value = item.fecha_nacimiento || '';
                        document.getElementById('telefono-personal-cliente').value = item.telefono_contacto || '';
                        document.getElementById('telefono-familiar-cliente').value = item.telefono_familiar || '';
                        document.getElementById('descripcion-cliente').value = item.descripcion || '';
                        
                        // Cargar selects para gestor y hogar
                        cargarDatos('/gestoresActivos', document.getElementById('gestor-cliente'), 'gestor', 'activo');
                        cargarDatos('/VerHogaresActivos', document.getElementById('hogar-cliente'), 'hogar', 'activo');
                        
                        // Establecer valores seleccionados
                        if (item.id_gestor) {
                            document.getElementById('gestor-cliente').value = item.id_gestor;
                        }
                        if (item.id_hogar) {
                            document.getElementById('hogar-cliente').value = item.id_hogar;
                        }
                    }
                }
            })
            .catch(error => console.error(`Error al cargar los detalles del ${tipo}:`, error));

        // Mostrar botones
        document.getElementById(`modificar-${tipo}`).style.display = 'inline';
        document.getElementById(`guardar-${tipo}`).style.display = 'none';
    }

    // Función para activar la edición
    function activarEdicion(tipo) {
        const campos = document.querySelectorAll(`#editar-${tipo} input, #editar-${tipo} select, #editar-${tipo} textarea`);
        campos.forEach(campo => {
            campo.disabled = false;
        });

        document.getElementById(`modificar-${tipo}`).style.display = 'none';
        document.getElementById(`guardar-${tipo}`).style.display = 'inline';
    }

    // Función para guardar cambios
    function guardarCambios(tipo) {
        const select = document.querySelector(`#${tipo}-activo-select, #${tipo}-inactivo-select`);
        const id = select.value;
        const estado = select.id.includes('activo') ? 'activo' : 'inactivo';
        
        let endpoint = '';
        let data = {};

        if (tipo === 'gestor') {
            endpoint = `/trabajadores/${id}`;
            data = {
                nombre: document.getElementById('nombre-gestor').value,
                apellido1: document.getElementById('apellido1-gestor').value,
                apellido2: document.getElementById('apellido2-gestor').value,
                nombre_usuario: document.getElementById('usuario-gestor').value,
                contraseña: document.getElementById('contrasena-gestor').value,
                activo: estado,
                gestor_data: {
                    color: document.getElementById('color-gestor').value
                }
            };
        } 
        else if (tipo === 'cuidador') {
            endpoint = `/trabajadores/${id}`;
            data = {
                nombre: document.getElementById('nombre-cuidador').value,
                apellido1: document.getElementById('apellido1-cuidador').value,
                apellido2: document.getElementById('apellido2-cuidador').value,
                nombre_usuario: document.getElementById('usuario-cuidador').value,
                contraseña: document.getElementById('contrasena-cuidador').value,
                activo: estado,
                cuidador_data: {
                    telefono: document.getElementById('telefono-cuidador').value
                }
            };
        } 
        else if (tipo === 'hogar') {
            endpoint = `/hogares/${id}`;
            data = {
                direccion: document.getElementById('direccion-hogar').value,
                Cod_Postal: document.getElementById('codigo_postal-hogar').value,
                Provincia: document.getElementById('provincia-hogar').value,
                url: document.getElementById('url_homeassistant-hogar').value,
                token: document.getElementById('token_homeassistant-hogar').value,
                activo: estado
            };
        } 
        else if (tipo === 'cliente') {
            endpoint = `/clientes/${id}`;
            data = {
                nombre: document.getElementById('nombre-cliente').value,
                apellido1: document.getElementById('apellido1-cliente').value,
                apellido2: document.getElementById('apellido2-cliente').value,
                dni: document.getElementById('dni-cliente').value,
                sexo: document.getElementById('sexo-cliente').value,
                fecha_nacimiento: document.getElementById('fecha_nacimiento-cliente').value,
                telefono_contacto: document.getElementById('telefono-personal-cliente').value,
                telefono_familiar: document.getElementById('telefono-familiar-cliente').value,
                descripcion: document.getElementById('descripcion-cliente').value,
                id_gestor: document.getElementById('gestor-cliente').value,
                id_hogar: document.getElementById('hogar-cliente').value,
                email: "Pruebasgreggerg@gmail.com",
                activo: estado
            };
            console.log("Datos enviados al guardar cliente:", data);

        }

        fetch(endpoint, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${tipo.charAt(0).toUpperCase() + tipo.slice(1)} actualizado correctamente`);
                // Deshabilitar campos después de guardar
                const campos = document.querySelectorAll(`#editar-${tipo} input, #editar-${tipo} select, #editar-${tipo} textarea`);
                campos.forEach(campo => {
                    campo.disabled = true;
                });
                
                document.getElementById(`modificar-${tipo}`).style.display = 'inline';
                document.getElementById(`guardar-${tipo}`).style.display = 'none';
                
                // Recargar los datos en los selects
                if (tipo === 'gestor') {
                    mostrarContenedorGestores();
                } else if (tipo === 'cuidador') {
                    mostrarContenedorCuidadores();
                } else if (tipo === 'hogar') {
                    mostrarContenedorHogares();
                } else if (tipo === 'cliente') {
                    mostrarContenedorClientes();
                }
            } else {
                alert(`Error al actualizar ${tipo}: ${data.message || 'Error desconocido'}`);
            }
        })
        .catch(error => {
            console.error(`Error al actualizar ${tipo}:`, error);
            alert(`Error al actualizar ${tipo}`);
        });
    }

    // Funciones específicas para cada tipo (wrappers de las funciones genéricas)
    function activarEdicionGestor() {
        activarEdicion('gestor');
    }

    function guardarCambiosGestor() {
        guardarCambios('gestor');
    }

    function activarEdicionCuidador() {
        activarEdicion('cuidador');
    }

    function guardarCambiosCuidador() {
        guardarCambios('cuidador');
    }

    function activarEdicionHogar() {
        activarEdicion('hogar');
    }

    function guardarCambiosHogar() {
        guardarCambios('hogar');
    }

    function activarEdicionCliente() {
        activarEdicion('cliente');
    }

    function guardarCambiosCliente() {
        guardarCambios('cliente');
    }

    // Event listeners para los selects
    document.getElementById('gestor-activo-select').addEventListener('change', function() {
        if (this.value) {
            rellenarFormularioDesdeMemoria('gestor', this.value);
        }
    });

    document.getElementById('gestor-inactivo-select').addEventListener('change', function() {
        if (this.value) {
            rellenarFormularioDesdeMemoria('gestor', this.value);
        }
    });

    document.getElementById('cuidador-activo-select').addEventListener('change', function() {
        if (this.value) {
            rellenarFormularioDesdeMemoria('cuidador', this.value);
        }
    });

    document.getElementById('cuidador-inactivo-select').addEventListener('change', function() {
        if (this.value) {
            rellenarFormularioDesdeMemoria('cuidador', this.value);
        }
    });

    document.getElementById('hogar-activo-select').addEventListener('change', function() {
        if (this.value) {
            rellenarFormularioDesdeMemoria('hogar', this.value);
        }
    });

    document.getElementById('hogar-inactivo-select').addEventListener('change', function() {
        if (this.value) {
            rellenarFormularioDesdeMemoria('hogar', this.value);
        }
    });

    document.getElementById('cliente-activo-select').addEventListener('change', function() {
        if (this.value) {
            rellenarFormularioDesdeMemoria('cliente', this.value);
        }
    });

    document.getElementById('cliente-inactivo-select').addEventListener('change', function() {
        if (this.value) {
            rellenarFormularioDesdeMemoria('cliente', this.value);
        }
    });

    // Funciones para manejar formularios de creación
    async function handleFetch(url, options, successMessage) {
        try {
            const response = await fetch(url, options);
            let data;
            
            try {
                data = await response.json();
            } catch (e) {
                console.error('El servidor no devolvió JSON válido', {
                    status: response.status,
                    statusText: response.statusText
                });
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            console.log('Respuesta del servidor:', data);

            if (!response.ok || !data.success) {
                const errorMsg = data.message || `Error ${response.status}`;
                console.error('Error en la respuesta', { response, data });
                throw new Error(errorMsg);
            }

            alert(successMessage);
            return data;
        } catch (error) {
            console.error('Error en la petición:', error);
            alert(`Error: ${error.message}`);
            throw error;
        }
    }

    // Submit del formulario de gestor
    document.getElementById('formulario-gestor').onsubmit = async function(event) {
        event.preventDefault();
        console.log('Intentando enviar formulario de gestor');

        const formData = new FormData(this);
        const gestorData = {
            nombre: formData.get('nombre'),
            apellido1: formData.get('apellido1'),
            apellido2: formData.get('apellido2'),
            nombre_usuario: formData.get('usuario'),
            contraseña: formData.get('contrasena'),
            color: formData.get('color'),
            activo: 'activo',
            gestor_data: {
                color: formData.get('color')
            }
        };

        console.log('Datos del gestor preparados:', gestorData);

        try {
            await handleFetch('/trabajadores/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(gestorData)
            }, 'Gestor añadido correctamente');
            
            this.reset();
        } catch (error) {
            // El error ya fue manejado por handleFetch
        }
    };

    // Submit del formulario de cuidador
    document.getElementById('formulario-cuidador').onsubmit = async function(event) {
        event.preventDefault();
        console.log('Intentando enviar formulario de cuidador');

        const formData = new FormData(this);
        const cuidadorData = {
            nombre: formData.get('nombre'),
            apellido1: formData.get('apellido1'),
            apellido2: formData.get('apellido2'),
            nombre_usuario: formData.get('usuario'),
            contraseña: formData.get('contrasena'),
            cuidador_data: {
                telefono: formData.get('telefono')
            },
            activo: 'activo',
        };

        console.log('Datos del cuidador preparados:', cuidadorData);

        try {
            await handleFetch('/trabajadores/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cuidadorData)
            }, 'Cuidador añadido correctamente');
            
            this.reset();
        } catch (error) {
            // El error ya fue manejado por handleFetch
        }
    };

    // Submit del formulario de hogar
    document.getElementById('formulario-hogar').onsubmit = async function(event) {
        event.preventDefault();
        console.log('Intentando enviar formulario de hogar');

        const formData = new FormData(this);
        const hogarData = {
            url: formData.get('url_homeassistant'),
            token: formData.get('token_homeassistant'),
            direccion: formData.get('direccion'),
            codigo_postal: formData.get('codigo_postal'),
            provincia: formData.get('provincia'),
            activo: 'activo',
        };

        console.log('Datos del hogar preparados:', hogarData);

        try {
            const response = await fetch('/hogares/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(hogarData)
            });
            
            const data = await response.json();
            console.log('Respuesta del servidor:', data);

            if (data.success) {
                alert('Hogar añadido correctamente');
                this.reset();
            } else {
                alert(`Error al añadir hogar: ${data.message || 'Error desconocido'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión al intentar añadir hogar');
        }
    };

    // Submit del formulario de cliente
    document.getElementById('formulario-cliente').onsubmit = async function(event) {
        event.preventDefault();
        console.log('Intentando enviar formulario de cliente');

        const formData = new FormData(this);
        
        // Validación básica
        if (!formData.get('dni') || !/^[0-9]{8}[A-Za-z]$/.test(formData.get('dni'))) {
            alert('Por favor, introduce un DNI válido (8 números y 1 letra)');
            return;
        }

        if (!formData.get('fecha_nacimiento')) {
            alert('Por favor, introduce una fecha de nacimiento válida');
            return;
        }

        const clienteData = {
            nombre: formData.get('nombre'),
            apellido1: formData.get('apellido1'),
            apellido2: formData.get('apellido2'),
            dni: formData.get('dni').toUpperCase(), // Aseguramos mayúscula
            sexo: formData.get('sexo'),
            descripcion: formData.get('descripcion'),
            fecha_nacimiento: formData.get('fecha_nacimiento'),
            telefono_contacto: formData.get('telefono_personal'),
            telefono_familiar: formData.get('telefono_familiar'),
            id_hogar: parseInt(formData.get('hogar')), // Aseguramos número
            id_gestor: parseInt(formData.get('gestor')), // Aseguramos número
            activo: 'activo',
        };

        console.log('Datos del cliente preparados:', clienteData);

        try {
            await handleFetch('/clientes/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(clienteData)
            }, 'Cliente añadido correctamente');
            
            this.reset();
        } catch (error) {
            // El error ya fue manejado por handleFetch
        }
    };


function rellenarFormularioDesdeMemoria(tipo, id) {
    let item;
    if (tipo === 'gestor') item = datosGestores[id];
    else if (tipo === 'cuidador') item = datosCuidadores[id];
    else if (tipo === 'hogar') item = datosHogares[id];
    else if (tipo === 'cliente') item = datosClientes[id];

    if (!item) return;

    document.querySelectorAll(`#editar-${tipo}`).forEach(form => form.style.display = 'block');

    const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };

    if (tipo === 'gestor') {
        set('nombre-gestor', item.nombre);
        set('apellido1-gestor', item.apellido1);
        set('apellido2-gestor', item.apellido2);
        set('usuario-gestor', item.nombre_usuario);
        set('contrasena-gestor', item.contraseña);
        set('color-gestor', item.gestor_data?.color || '#000000');
    } else if (tipo === 'cuidador') {
        set('nombre-cuidador', item.nombre);
        set('apellido1-cuidador', item.apellido1);
        set('apellido2-cuidador', item.apellido2);
        set('usuario-cuidador', item.nombre_usuario);
        set('contrasena-cuidador', item.contraseña);
        set('telefono-cuidador', item.cuidador_data?.telefono);
    } else if (tipo === 'hogar') {
        set('direccion-hogar', item.direccion);
        set('codigo_postal-hogar', item.codigo_postal || item.Cod_Postal);
        set('provincia-hogar', item.provincia || item.Provincia);
        set('url_homeassistant-hogar', item.url);
        set('token_homeassistant-hogar', item.token);
    } else if (tipo === 'cliente') {
        set('nombre-cliente', item.nombre);
        set('apellido1-cliente', item.apellido1);
        set('apellido2-cliente', item.apellido2);
        set('dni-cliente', item.dni);
        set('sexo-cliente', item.sexo);
        set('fecha_nacimiento-cliente', item.fecha_nacimiento);
        set('telefono-personal-cliente', item.telefono_contacto);
        set('telefono-familiar-cliente', item.telefono_familiar);
        set('descripcion-cliente', item.descripcion);

        cargarDatos('/gestoresActivos', document.getElementById('gestor-cliente'), 'gestor', 'activo');
        cargarDatos('/VerHogaresActivos', document.getElementById('hogar-cliente'), 'hogar', 'activo');

        setTimeout(() => {
            set('gestor-cliente', item.id_gestor);
            set('hogar-cliente', item.id_hogar);
        }, 1000);
    }

    activarEdicion(tipo);
}

</script>
</body>
</html>
