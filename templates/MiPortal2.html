<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Administrar</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/miportal2.css') }}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<header class="main-header" id="movible-header">
    <div class="nav-left">
        <a href="{{ url_for('root') }}"><img src="{{ url_for('static', path='img/logo_casa.png') }}" alt="Logo_Casa" class="Logo_Casa"/></a>
    </div>
    <div class="nav-center">
        <img src="{{ url_for('static', path='img/img.png') }}" alt="Logo Fundación" class="logo"/>
    </div>
    <div class="nav-right">
        <img src="{{ url_for('static', path='img/img_1.png') }}" alt="Foto perfil"/>
        <div class="dropdown">
            <span>{{ usuario or "Nombre Usuario" }}</span>
            <div class="dropdown-content"><a href="{{ url_for('logout') }}">Cerrar sesión</a></div>
        </div>
    </div>
</header>

<main class="contenedor-principal">
    <aside class="columna-izquierda">
        <button class="boton-admin" onclick="mostrarOpciones('gestores')">Gestores</button>
        <button class="boton-admin" onclick="mostrarOpciones('cuidadores')">Cuidadores</button>
        <button class="boton-admin" onclick="mostrarOpciones('hogares')">Hogares</button>
        <button class="boton-admin" onclick="mostrarOpciones('clientes')">Clientes</button>
    </aside>

    <section class="columna-derecha">
        <div id="opciones-gestores" class="sub-botones fila-dos-botones">
            <button class="boton-subgestor" onclick="mostrarFormularioGestor()">Añadir gestor</button>
            <!-- Formulario Añadir Gestor -->
        <form id="formulario-gestor" class="formulario-usuario" style="display: none;" onsubmit="event.preventDefault();">
            <div class="campo-formulario">
                <label><i class="fas fa-user"></i> Nombre:</label>
                <input type="text" name="nombre" required>
            </div>
            <div class="campo-formulario">
                <label><i class="fas fa-user-tag"></i> Primer apellido:</label>
                <input type="text" name="apellido1" required>
            </div>
            <div class="campo-formulario">
                <label><i class="fas fa-user-tag"></i> Segundo apellido:</label>
                <input type="text" name="apellido2">
            </div>
            <div class="campo-formulario">
                <label><i class="fas fa-user-circle"></i> Nombre de usuario:</label>
                <input type="text" name="usuario" required>
            </div>
            <div class="campo-formulario">
                <label><i class="fas fa-lock"></i> Contraseña:</label>
                <input type="password" name="contrasena" required>
            </div>
            <button type="submit" class="boton-enviar">Guardar</button>
        </form>
            <button class="boton-subgestor" onclick="mostrarEstadosGestor()">Modificar gestor</button>

            <!-- Contenedores separados para "Activo" e "Inactivo" -->
            <div id="estado-gestor" class="estado-container" style="display: none;">
                <div>
                    <div class="estado-caja">Activo</div>
                    <div id="gestor-activo">
                        <label for="gestor-activo-select">Seleccionar gestor:</label>
                        <select id="gestor-activo-select">
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                </div>

                <div>
                    <div class="estado-caja">Inactivo</div>
                    <div class="gestor-inactivo">
                        <label for="gestor-inactivo-select">Seleccionar gestor:</label>
                        <select id="gestor-inactivo-select">
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div id="opciones-cuidadores" class="sub-botones fila-dos-botones">
            <button class="boton-subcuidador" onclick="mostrarFormularioCuidador()">Añadir cuidador</button>
            <!-- Formulario Añadir Cuidador -->
            <form id="formulario-cuidador" class="formulario-usuario" style="display: none;" onsubmit="event.preventDefault();">
                <div class="campo-formulario">
                    <label><i class="fas fa-user"></i> Nombre:</label>
                    <input type="text" name="nombre" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-user-tag"></i> Primer apellido:</label>
                    <input type="text" name="apellido1" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-user-tag"></i> Segundo apellido:</label>
                    <input type="text" name="apellido2">
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-phone"></i> Teléfono:</label>
                    <input type="tel" name="telefono" pattern="[0-9]{9}" placeholder="Ej: 612345678" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-user-circle"></i> Nombre de usuario:</label>
                    <input type="text" name="usuario" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-lock"></i> Contraseña:</label>
                    <input type="password" name="contrasena" required>
                </div>
                <button type="submit" class="boton-enviar">Guardar</button>
            </form>
            <button class="boton-subcuidador" onclick="mostrarEstadosCuidador()">Modificar cuidador</button>

            <!-- Panel Activo/Inactivo para Cuidador -->
            <div id="estado-cuidador" class="estado-container" style="display: none;">
                <div>
                    <div class="estado-caja">Activo</div>
                    <div class="cuidador-activo">
                        <label for="cuidador-activo-select">Seleccionar cuidador:</label>
                        <select id="cuidador-activo-select">
                            <option value="">-- Seleccionar --</option>

                        </select>
                    </div>
                </div>

                <div>
                    <div class="estado-caja">Inactivo</div>
                    <div class="cuidador-inactivo">
                        <label for="cuidador-inactivo-select">Seleccionar cuidador:</label>
                        <select id="cuidador-inactivo-select">
                            <option value="">-- Seleccionar --</option>

                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div id="opciones-hogares" class="sub-botones fila-dos-botones">
            <button class="boton-subcuidador" onclick="mostrarFormularioHogar()">Añadir hogar</button>
            <!-- Formulario Añadir Hogar -->
            <form id="formulario-hogar" class="formulario-usuario" style="display: none;" onsubmit="event.preventDefault();">
                <div class="campo-formulario">
                    <label><i class="fas fa-map-marker-alt"></i> Dirección:</label>
                    <input type="text" name="direccion" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-envelope"></i> Código Postal:</label>
                    <input type="text" name="codigo_postal" pattern="[0-9]{5}" placeholder="Ej: 28001" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-flag"></i> Provincia:</label>
                    <input type="text" name="provincia" required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-link"></i> URL Home Assistant:</label>
                    <input type="url" name="url_homeassistant" placeholder="https://..." required>
                </div>
                <div class="campo-formulario">
                    <label><i class="fas fa-key"></i> Token Home Assistant:</label>
                    <input type="text" name="token_homeassistant" required>
                </div>
                <button type="submit" class="boton-enviar">Guardar</button>
            </form>
            <button class="boton-subhogar" onclick="mostrarEstadosHogar()">Modificar hogar</button>

            <div id="estado-hogar" class="estado-container" style="display: none;">
                <div>
                    <div class="estado-caja">Activo</div>
                    <div class="hogar-activo">
                        <label for="hogar-activo-select">Seleccionar hogar:</label>
                        <select id="hogar-activo-select">
                            <option value="">-- Seleccionar --</option>

                        </select>
                    </div>
                </div>

                <div>
                    <div class="estado-caja">Inactivo</div>
                    <div class="hogar-inactivo">
                        <label for="hogar-inactivo-select">Seleccionar hogar:</label>
                        <select id="hogar-inactivo-select">
                            <option value="">-- Seleccionar --</option>

                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div id="opciones-clientes" class="sub-botones fila-dos-botones">
            <button class="boton-subcliente" onclick="mostrarFormularioCliente()">Añadir cliente</button>
            <!-- Formulario Añadir Cliente -->
            <form id="formulario-cliente" class="formulario-usuario-dos-columnas" style="display: none;" onsubmit="event.preventDefault();">
                <!-- Columna izquierda -->
                <div class="columna-formulario">
                    <div class="campo-formulario">
                        <label><i class="fas fa-user-tie"></i> Gestor:</label>
                        <select name="gestor" required>
                            <option value="">-- Seleccionar gestor --</option>

                        </select>
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-user"></i> Nombre:</label>
                        <input type="text" name="nombre" required>
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-user-tag"></i> Primer apellido:</label>
                        <input type="text" name="apellido1" required>
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-user-tag"></i> Segundo apellido:</label>
                        <input type="text" name="apellido2">
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-id-card"></i> DNI:</label>
                        <input type="text" name="dni" required>
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-venus-mars"></i> Sexo:</label>
                        <select name="sexo" required>
                            <option value="">-- Seleccionar sexo --</option>
                            <option value="hombre">Hombre</option>
                            <option value="mujer">Mujer</option>
                        </select>
                    </div>
                </div>

                <!-- Columna derecha -->
                <div class="columna-formulario">
                    <div class="campo-formulario">
                        <label><i class="fas fa-calendar"></i> Fecha de nacimiento:</label>
                        <input type="date" name="fecha_nacimiento" required>
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-phone"></i> Teléfono personal:</label>
                        <input type="tel" name="telefono_personal">
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-phone-volume"></i> Teléfono familiar:</label>
                        <input type="tel" name="telefono_familiar">
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-home"></i> Hogar:</label>
                        <select name="hogar" required>
                            <option value="">-- Seleccionar hogar --</option>

                        </select>
                    </div>
                    <div class="campo-formulario">
                        <label><i class="fas fa-align-left"></i> Descripción:</label>
                        <textarea name="descripcion" rows="3"></textarea>
                    </div>
                </div>

                <div class="boton-enviar-contenedor">
                    <button type="submit" class="boton-enviar">Guardar</button>
                </div>
            </form>
            <button class="boton-subcliente" onclick="mostrarEstadosCliente()">Modificar cliente</button>

            <div id="estado-cliente" class="estado-container" style="display: none;">
                <div>
                    <div class="estado-caja">Activo</div>
                    <div class="cliente-activo">
                        <label for="cliente-activo-select">Seleccionar cliente:</label>
                        <select id="cliente-activo-select">
                            <option value="">-- Seleccionar --</option>

                        </select>
                    </div>
                </div>

                <div>
                    <div class="estado-caja">Inactivo</div>
                    <div class="cliente-inactivo">
                        <label for="cliente-inactivo-select">Seleccionar cliente:</label>
                        <select id="cliente-inactivo-select">
                            <option value="">-- Seleccionar --</option>

                        </select>
                    </div>
                </div>
            </div>
        </div>

    </section>
</main>

<script>


    // Función genérica para cargar datos en un select

    function mostrarOpciones(tipo) {
        document.querySelectorAll('.sub-botones').forEach(div => div.style.display = 'none');

        // Ocultar todos los paneles de estados y formularios
        document.getElementById('estado-gestor').style.display = 'none';
        document.getElementById('estado-cuidador').style.display = 'none';
        document.getElementById('estado-hogar').style.display = 'none';
        document.getElementById('estado-cliente').style.display = 'none';
        document.getElementById('formulario-gestor').style.display = 'none';
        document.getElementById('formulario-cuidador').style.display = 'none';
        document.getElementById('formulario-hogar').style.display = 'none';
        document.getElementById('formulario-cliente').style.display = 'none';

        const panel = document.getElementById(`opciones-${tipo}`);
        if (panel) panel.style.display = 'flex';
    }

    function mostrarFormularioGestor() {
        // Cerrar panel de modificar si está abierto
        document.getElementById('estado-gestor').style.display = 'none';

        // Abrir formulario
        document.getElementById('formulario-gestor').style.display = 'flex';
    }


    function mostrarFormularioCuidador() {
        // Cerrar panel de modificar si está abierto
        document.getElementById('estado-cuidador').style.display = 'none';

        // Abrir formulario
        document.getElementById('formulario-cuidador').style.display = 'flex';
    }


    function mostrarFormularioHogar() {
        // Cerrar panel de modificar si está abierto
        document.getElementById('estado-hogar').style.display = 'none';

        // Abrir formulario
        document.getElementById('formulario-hogar').style.display = 'flex';
    }

   function mostrarFormularioCliente() {
    // Cerrar panel de modificar si está abierto
    document.getElementById('estado-cliente').style.display = 'none';

    // Abrir formulario
    document.getElementById('formulario-cliente').style.display = 'flex';

    // Llamadas para llenar los selects dinámicamente
    const selectGestor = document.querySelector('select[name="gestor"]');
    const selectHogar = document.querySelector('select[name="hogar"]');

    cargarDatos('/gestoresActivos', selectGestor, 'gestor', 'activo', gestor => 
        `${gestor.nombre} ${gestor.apellido1} ${gestor.apellido2 || ''}`.trim());
    
    cargarDatos('/VerHogaresActivos', selectHogar, 'hogar', 'activo', hogar => 
        `${hogar.direccion} (${hogar.codigo_postal})`);
}

    function cargarDatos(url, selectElement, tipo, estado, formatter = null) {
        fetch(url)
            .then(response => response.json())
            .then(json => {
                if (!json.success || !Array.isArray(json.data)) {
                    throw new Error('Respuesta incorrecta desde ' + url);
                }

                // Limpiar opciones excepto la primera
                selectElement.length = 1;

                json.data.forEach(item => {
                    const option = document.createElement('option');
                    const id = item.id || item.id_gestor || item.id_cliente || item.id_cuidador || item.id_hogar;

                    option.value = id;
                    
                    // Usar el formatter personalizado si está disponible, o mostrar un campo común
                    option.textContent = formatter ? formatter(item) : (item.nombre || item.direccion || 'Sin nombre');
                    selectElement.appendChild(option);
                });

                // Añadir evento change para guardar la selección
                selectElement.addEventListener('change', function() {
                    seleccionesActuales[tipo][estado] = this.value;
                    console.log(`Selección actualizada - ${tipo} ${estado}:`, this.value);
                });
            })
            .catch(error => {
                console.error('Error cargando ' + url + ':', error);
            });
    }

    // Funciones específicas para cada tipo
    function mostrarContenedorGestores() {
        const contenedor = document.getElementById('estado-gestor');
        const selectActivo = document.getElementById('gestor-activo-select');
        const selectInactivo = document.getElementById('gestor-inactivo-select');

        contenedor.style.display = 'flex';
        cargarDatos('/gestoresActivos', selectActivo, 'gestor', 'activo', gestor => 
            `${gestor.nombre} ${gestor.apellido1} ${gestor.apellido2 || ''}`.trim());
        cargarDatos('/gestoresInactivos', selectInactivo, 'gestor', 'inactivo', gestor => 
            `${gestor.nombre} ${gestor.apellido1} ${gestor.apellido2 || ''}`.trim());
    }

    function mostrarContenedorCuidadores() {
        const contenedor = document.getElementById('estado-cuidador');
        const selectActivo = document.getElementById('cuidador-activo-select');
        const selectInactivo = document.getElementById('cuidador-inactivo-select');

        contenedor.style.display = 'flex';
        cargarDatos('/cuidadoresActivos', selectActivo, 'cuidador', 'activo', cuidador => 
            `${cuidador.nombre} ${cuidador.apellido1} ${cuidador.apellido2 || ''}`.trim());
        cargarDatos('/cuidadoresInactivos', selectInactivo, 'cuidador', 'inactivo', cuidador => 
            `${cuidador.nombre} ${cuidador.apellido1} ${cuidador.apellido2 || ''}`.trim());
    }

    function mostrarContenedorHogares() {
        const contenedor = document.getElementById('estado-hogar');
        const selectActivo = document.getElementById('hogar-activo-select');
        const selectInactivo = document.getElementById('hogar-inactivo-select');

        contenedor.style.display = 'flex';
        cargarDatos('/VerHogaresActivos', selectActivo, 'hogar', 'activo', hogar => 
            `${hogar.direccion} (${hogar.codigo_postal})`);
        cargarDatos('/VerHogaresInactivos', selectInactivo, 'hogar', 'inactivo', hogar => 
            `${hogar.direccion} (${hogar.codigo_postal})`);
    }

    function mostrarContenedorClientes() {
        const contenedor = document.getElementById('estado-cliente');
        const selectActivo = document.getElementById('cliente-activo-select');
        const selectInactivo = document.getElementById('cliente-inactivo-select');

        contenedor.style.display = 'flex';
        cargarDatos('/clientesActivos', selectActivo, 'cliente', 'activo', cliente => 
            `${cliente.nombre} ${cliente.apellido1} ${cliente.apellido2 || ''}`.trim());
        cargarDatos('/clientesInactivos', selectInactivo, 'cliente', 'inactivo', cliente => 
            `${cliente.nombre} ${cliente.apellido1} ${cliente.apellido2 || ''}`.trim());
    }

    // Función para obtener la selección actual
    function obtenerSeleccion(tipo, estado) {
        return seleccionesActuales[tipo][estado];
    }

    // Modificar las funciones existentes para usar las nuevas funciones de carga
    function mostrarEstadosGestor() {
        document.getElementById('formulario-gestor').style.display = 'none';
        mostrarContenedorGestores();
    }

    function mostrarEstadosCuidador() {
        document.getElementById('formulario-cuidador').style.display = 'none';
        mostrarContenedorCuidadores();
    }

    function mostrarEstadosHogar() {
        document.getElementById('formulario-hogar').style.display = 'none';
        mostrarContenedorHogares();
    }

    function mostrarEstadosCliente() {
        document.getElementById('formulario-cliente').style.display = 'none';
        mostrarContenedorClientes();
    }


    // Función para mostrar mensajes de debug
function debug(message, data = null) {
    console.log(`[DEBUG] ${message}`, data || '');
    if (data && data.error) {
        console.error('Error detallado:', data.error);
    }
}

async function handleFetch(url, options, successMessage) {
    try {
        const response = await fetch(url, options);
        let data;
        
        try {
            data = await response.json();
        } catch (e) {
            debug('El servidor no devolvió JSON válido', {
                status: response.status,
                statusText: response.statusText
            });
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        debug('Respuesta del servidor:', data);

        if (!response.ok || !data.success) {
            const errorMsg = data.message || `Error ${response.status}`;
            debug('Error en la respuesta', { response, data });
            throw new Error(errorMsg);
        }

        alert(successMessage);
        return data;
    } catch (error) {
        console.error('Error en la petición:', error);
        alert(`Error: ${error.message}`);
        throw error;
    }
}


    // Modificar el submit del formulario de gestor
 document.getElementById('formulario-gestor').onsubmit = async function(event) {
    event.preventDefault();
    debug('Intentando enviar formulario de gestor');

    const formData = new FormData(this);
    const gestorData = {
        nombre: formData.get('nombre'),
        apellido1: formData.get('apellido1'),
        apellido2: formData.get('apellido2'),
        nombre_usuario: formData.get('usuario'),
        contraseña: formData.get('contrasena'),
        activo: 'activo',
        gestor_data: {
            color: 'rojo'
        }
    };

    debug('Datos del gestor preparados:', gestorData);
    console.log('Datos a enviar (Gestor):', JSON.stringify(gestorData, null, 2));


    try {
        await handleFetch('/trabajadores/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(gestorData)
        }, 'Gestor añadido correctamente');
        
        this.reset();
    } catch (error) {
        // El error ya fue manejado por handleFetch
    }
};
    // Modificar el submit del formulario de cuidador
  document.getElementById('formulario-cuidador').onsubmit = async function(event) {
    event.preventDefault();
    debug('Intentando enviar formulario de cuidador');

    const formData = new FormData(this);
    const cuidadorData = {
        nombre: formData.get('nombre'),
        apellido1: formData.get('apellido1'),
        apellido2: formData.get('apellido2'),
        nombre_usuario: formData.get('usuario'),
        contraseña: formData.get('contrasena'),
        cuidador_data: {
        telefono: formData.get('telefono')
        },
        activo: 'activo',
    };

    debug('Datos del cuidador preparados:', cuidadorData);

    try {
        await handleFetch('/trabajadores/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cuidadorData)
        }, 'Cuidador añadido correctamente');
        
        this.reset();
    } catch (error) {
        // El error ya fue manejado por handleFetch
    }
};

    // Modificar el submit del formulario de hogar (ya funciona pero añado debug)
    document.getElementById('formulario-hogar').onsubmit = async function(event) {
        event.preventDefault();
        debug('Intentando enviar formulario de hogar');

        const formData = new FormData(this);
        const hogarData = {
            url: formData.get('url_homeassistant'),
            token: formData.get('token_homeassistant'),
            direccion: formData.get('direccion'),
            codigo_postal: formData.get('codigo_postal'),
            provincia: formData.get('provincia'),
            activo: 'activo',
        };

        debug('Datos del hogar preparados:', hogarData);

        try {
            const response = await fetch('/hogares/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(hogarData)
            });
            
            const data = await response.json();
            debug('Respuesta del servidor:', data);

            if (data.success) {
                alert('Hogar añadido correctamente');
                this.reset();
            } else {
                alert(`Error al añadir hogar: ${data.message || 'Error desconocido'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión al intentar añadir hogar');
        }
    };

    // Modificar el submit del formulario de cliente (ya funciona pero añado debug)
   document.getElementById('formulario-cliente').onsubmit = async function(event) {
    event.preventDefault();
    debug('Intentando enviar formulario de cliente');

    const formData = new FormData(this);
    
    // Validación básica
    if (!formData.get('dni') || !/^[0-9]{8}[A-Za-z]$/.test(formData.get('dni'))) {
        alert('Por favor, introduce un DNI válido (8 números y 1 letra)');
        return;
    }

    if (!formData.get('fecha_nacimiento')) {
        alert('Por favor, introduce una fecha de nacimiento válida');
        return;
    }

    const clienteData = {
        nombre: formData.get('nombre'),
        apellido1: formData.get('apellido1'),
        apellido2: formData.get('apellido2'),
        dni: formData.get('dni').toUpperCase(), // Aseguramos mayúscula
        sexo: formData.get('sexo'),
        descripcion: formData.get('descripcion'),
        fecha_nacimiento: formData.get('fecha_nacimiento'),
        telefono_contacto: formData.get('telefono_personal'),
        telefono_familiar: formData.get('telefono_familiar'),
        id_hogar: parseInt(formData.get('hogar')), // Aseguramos número
        id_gestor: parseInt(formData.get('gestor')), // Aseguramos número
        activo: 'activo',
    };

    debug('Datos del cliente preparados:', clienteData);

    try {
        await handleFetch('/clientes/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(clienteData)
        }, 'Cliente añadido correctamente');
        
        this.reset();
    } catch (error) {
        // El error ya fue manejado por handleFetch
    }
};




    // Inicialización (opcional, para cargar datos al abrir la página)
    document.addEventListener('DOMContentLoaded', () => {
        // Puedes cargar datos iniciales aquí si lo deseas
    });



</script>
</body>
</html>
