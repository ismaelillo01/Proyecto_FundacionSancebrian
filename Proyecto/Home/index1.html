<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Panel de Usuario</title>
    <link rel="stylesheet" href="estilos_2.css" />
</head>
<body>
<header class="header">
    <div class="left">
        <button class="menu-btn" id="menuBtn">&#9662;</button>
        <p class="menu-title" id="menuTitle">Vista general</p>
        <nav class="menu hidden" id="menu">
            <a href="index2.html">Datos sensores</a>
            <a href="#">Apartado 2</a>
            <a href="#">Apartado 3</a>
        </nav>
    </div>
    <div class="center">
        <img src="img/img.png" alt="Logo" class="logo" />
    </div>
    <div class="right">
        <img src="img/img_3.png" alt="Avatar" class="user-avatar" />
        <span id="usernameDisplay">Usuario</span>
    </div>
</header>

<main>
    <!-- Selector de usuario -->
    <section class="usuario-selector section-box">
        <h2 class="section-header">Usuarios</h2>
        <div class="autocomplete">
            <input
                    type="text"
                    id="userInput"
                    placeholder="Buscar usuario"
                    autocomplete="off"
            />
            <button id="toggleBtn">&#9662;</button>
            <div id="suggestions" class="suggestions"></div>
        </div>
    </section>

    <!-- Información del usuario -->
    <section id="usuario-info" class="usuario-info section-box">
        <!-- Cargado desde JS -->
    </section>

    <!-- Actividades y Notificaciones -->
    <section class="panel-actividades-notificaciones">
        <!-- IZQUIERDA -->
        <div class="actividades section-box">
            <label for="fechaInput">Seleccionar fecha:</label>
            <div class="fecha-selector">
                <input type="date" id="fechaInput" />
                <span class="calendar-icon">&#128197;</span>
            </div>
            <table id="tabla-actividades">
                <thead>
                <tr>
                    <th>Hora Inicio - Fin</th>
                    <th>Actividad</th>
                    <th>Hora Realizada</th>
                    <th>Estado</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- DERECHA -->
        <div class="notificaciones section-box">
            <div class="notificaciones-header">
                <h3 class="section-header">Notificaciones / Avisos</h3><br>
                <img src="img/img_4.png" alt="Reiniciar" id="reloadBtn" title="Actualizar" class="reload-icon"/>
            </div>
            <table id="tabla-notificaciones">
                <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Peligro</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>
    <section class="control-panel section-box">
        <div class="botones-fila">
            <button id="btnLocalizar">Localizar usuario</button>
            <button id="btnReproducir">Reproducir mensaje</button>
            <button id="btnVideollamada">Videollamada</button>
        </div>
        <div class="plano-casa">
            <img src="img/img_6.png" alt="plano casa" class="plano-casa-img"/>
        </div>
    </section>
</main>

<script>
    // Menu vista general toggle
    const menuBtn = document.getElementById("menuBtn");
    const menuTitle = document.getElementById("menuTitle");
    const menu = document.getElementById("menu");

    function toggleMenu() {
        menu.classList.toggle("hidden");
    }

    menuBtn.addEventListener("click", toggleMenu);
    menuTitle.addEventListener("click", toggleMenu);

    // Cerrar menú si click fuera
    document.addEventListener("click", (e) => {
        if (
            !menu.contains(e.target) &&
            e.target !== menuBtn &&
            e.target !== menuTitle
        ) {
            menu.classList.add("hidden");
        }
    });

    // Mostrar usuario guardado
    const username = localStorage.getItem("username");
    if (username) {
        document.getElementById("usernameDisplay").textContent = username;
    }

    // Autocomplete usuarios
    const userInput = document.getElementById("userInput");
    const suggestions = document.getElementById("suggestions");
    const toggleBtn = document.getElementById("toggleBtn");
    let users = [];
    let userActividades = [];  // guardamos las actividades del usuario para filtrar sin hacer fetch cada vez

    async function fetchUsers() {
        const res = await fetch("/api/usuarios");
        return await res.json();
    }

    function showSuggestions(list) {
        suggestions.innerHTML = "";
        list.forEach((name) => {
            const item = document.createElement("div");
            item.textContent = name;
            item.classList.add("suggestion-item");
            item.addEventListener("click", () => {
                userInput.value = name;
                suggestions.style.display = "none";
                cargarUsuario(name);
            });
            suggestions.appendChild(item);
        });
        suggestions.style.display = "block";
    }

    userInput.addEventListener("input", () => {
        const filtro = userInput.value.toLowerCase();
        const filtrados = users.filter((name) =>
            name.toLowerCase().startsWith(filtro)
        );
        showSuggestions(filtrados);
    });

    toggleBtn.addEventListener("click", () => {
        showSuggestions(users);
    });

    document.addEventListener("click", (e) => {
        if (
            !suggestions.contains(e.target) &&
            e.target !== userInput &&
            e.target !== toggleBtn
        ) {
            suggestions.style.display = "none";
        }
    });

    async function cargarUsuario(nombre) {
        const res = await fetch(`/api/usuarios/${nombre}`);
        const user = await res.json();

        document.getElementById(
            "usuario-info"
        ).innerHTML = `<div class="info-container">
          <img src="${user.foto}" alt="${user.nombre}" />
          <div>
            <h3>${user.nombre}</h3>
            <hr />
            <ul>
              <li><strong>Fecha de nacimiento:</strong> ${user.fechaNacimiento}</li>
              <li><strong>Dirección:</strong> ${user.direccion}</li>
              <li><strong>Patologías:</strong> ${
            user.patologias.length ? user.patologias.join(", ") : "Ninguna"
        }</li>
            </ul>
          </div>
        </div>`;

        userActividades = user.actividades || [];

        renderActividades();       // mostramos actividades pendientes para la fecha actual o sin fecha
        renderActividadesHechas(); // mostramos actividades hechas
    }

    function renderActividades() {
        const fechaInput = document.getElementById("fechaInput").value;
        const tbody = document.querySelector("#tabla-actividades tbody");

        // Filtrar actividades pendientes para la fecha seleccionada (o todas si no hay fecha)
        const actividadesPendientes = userActividades.filter(act =>
            act.estado.toLowerCase() === 'pendiente' &&
            (!fechaInput || act.fecha === fechaInput)
        );

        tbody.innerHTML = actividadesPendientes
            .map(
                (act) => `<tr>
                    <td>${act.horaInicio} - ${act.horaFin}</td>
                    <td>${act.nombre}</td>
                    <td></td>
                    <td>${act.estado}</td>
                </tr>`
            )
            .join("");
    }

    function renderActividadesHechas() {
        const tbody = document.querySelector("#tabla-notificaciones tbody");

        // Filtrar actividades hechas (completadas)
        const actividadesHechas = userActividades.filter(act => act.estado.toLowerCase() === 'completada');

        tbody.innerHTML = actividadesHechas
            .map(
                (act) => `<tr>
                    <td>${act.fecha}</td>
                    <td>${act.horaRealizada || act.horaInicio}</td>
                    <td>${act.nombre}</td>
                </tr>`
            )
            .join("");
    }

    fetchUsers().then((u) => (users = u));

    // Actualizar actividades pendientes cuando se cambie la fecha
    document.getElementById("fechaInput").addEventListener("change", () => {
        renderActividades();
    });

    // Recargar usuario al pulsar botón actualizar
    document.getElementById("reloadBtn").addEventListener("click", () => {
        const nombre = userInput.value;
        if (nombre) {
            cargarUsuario(nombre);
        }
    });
    document.getElementById('btnLocalizar').addEventListener('click', () => {
        // Aquí irá la lógica para localizar al usuario
        alert('Función Localizar usuario activada');
    });

    document.getElementById('btnReproducir').addEventListener('click', () => {
        // Aquí irá la lógica para reproducir mensaje
        alert('Función Reproducir mensaje activada');
    });

    document.getElementById('btnVideollamada').addEventListener('click', () => {
        // Aquí irá la lógica para iniciar videollamada
        alert('Función Videollamada activada');
    });
</script>
</body>
</html>
